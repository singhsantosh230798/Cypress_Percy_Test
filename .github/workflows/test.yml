name: Cypress + Percy Visual Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # -------------------------------------------------------
  # CYPRESS + PERCY TEST EXECUTION
  # -------------------------------------------------------
  cypress-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i

      - name: Install Percy CLI
        run: npm install -g @percy/cli

      - name: Run Cypress Tests with Percy
        run: npx percy exec -- npm run test


  # -------------------------------------------------------
  # FINAL WORKING PERCY REVIEW JOB
  # -------------------------------------------------------
  percy-review:
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_API: "https://percy.io/api/v1"
      TARGET_PROJECT_NAME: "Santosh_cypress_1"

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq


      # ==============================================
      # 1Ô∏è‚É£ GET PROJECT DETAILS (CORRECT FIXED VERSION)
      # ==============================================
      - name: Fetch Percy Project Info
        id: fetch-project
        run: |
          echo "Fetching Percy Project..."

          PROJECT=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/projects")
          echo "$PROJECT" | jq

          PROJECT_NAME=$(echo "$PROJECT" | jq -r '.data.attributes.name')
          PROJECT_ID=$(echo "$PROJECT" | jq -r '.data.id')

          echo "PROJECT_NAME = $PROJECT_NAME"
          echo "PROJECT_ID   = $PROJECT_ID"

          if [[ "$PROJECT_NAME" != "$TARGET_PROJECT_NAME" ]]; then
            echo "‚ùå ERROR: Expected project '$TARGET_PROJECT_NAME' but API returned '$PROJECT_NAME'"
            exit 1
          fi

          echo "üéØ Project validated: $PROJECT_NAME"
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV


      # =====================================================
      # 2Ô∏è‚É£ GET LATEST BUILD FOR THIS PROJECT ID (OFFICIAL API)
      # =====================================================
      - name: Fetch Latest Percy Build
        id: fetch-build
        run: |
          echo "Fetching builds for project ID: $PROJECT_ID"

          BUILDS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/projects/$PROJECT_ID/builds?per_page=10")

          echo "BUILDS RESPONSE:"
          echo "$BUILDS" | jq

          BUILD_ID=$(echo "$BUILDS" | jq -r '.data[0].id')

          if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
            echo "‚ùå No builds found for project ID: $PROJECT_ID"
            exit 1
          fi

          echo "üéØ Latest Percy Build ID = $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV


      # =====================================================
      # 2.5Ô∏è‚É£ WAIT UNTIL BUILD FINISHES (IMPORTANT FIX)
      # =====================================================
      - name: Wait for Percy build to finish
        run: |
          echo "‚è≥ Waiting for Percy build to finish..."

          for i in {1..30}; do
            STATUS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID" | jq -r '.data.attributes.state')

            echo "Attempt $i/30 ‚Üí Status: $STATUS"

            if [[ "$STATUS" == "finished" ]]; then
              echo "üéâ Build finished!"
              break
            fi

            sleep 5
          done

          if [[ "$STATUS" != "finished" ]]; then
            echo "‚ùå ERROR: Percy build did not finish within timeout"
            exit 1
          fi


      # =====================================================
      # 3Ô∏è‚É£ GET BUILD DETAILS (OFFICIAL DOC API)
      # =====================================================
      - name: Fetch Build Details
        id: build-details
        run: |
          echo "Fetching build details for build $BUILD_ID"

          DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/builds/$BUILD_ID")

          echo "$DATA" | jq

          TOTAL=$(echo "$DATA" | jq '.data.attributes["total-snapshots"]')
          DIFFS=$(echo "$DATA" | jq '.data.attributes["total-diffs"]')
          BUILD_URL=$(echo "$DATA" | jq -r '.data.attributes."web-url"')
          REVIEW_STATE=$(echo "$DATA" | jq -r '.data.attributes."review-state"')

          if [[ "$TOTAL" -gt 0 ]]; then
            PERCENT=$(echo "scale=2; $DIFFS * 100 / $TOTAL" | bc)
          else
            PERCENT=0
          fi

          echo "----------------------------------------"
          echo "Percy Build Summary:"
          echo "Build ID:      $BUILD_ID"
          echo "Build URL:     $BUILD_URL"
          echo "Snapshots:     $TOTAL"
          echo "Diffs:         $DIFFS"
          echo "Diff Percent:  $PERCENT%"
          echo "Review state:  $REVIEW_STATE"
          echo "----------------------------------------"

          echo "DIFF_PERCENT=$PERCENT" >> $GITHUB_ENV


      # =====================================================
      # 4Ô∏è‚É£ APPROVE OR UNAPPROVE ACCORDING TO DIFF %
      # =====================================================
      - name: Approve or Reject Build
        run: |
          THRESHOLD=1  # 1% allowed diff

          echo "Threshold = $THRESHOLD%"
          echo "Actual diff = $DIFF_PERCENT%"

          if (( $(echo "$DIFF_PERCENT <= $THRESHOLD" | bc -l) )); then
            echo "‚úî APPROVING BUILD $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/approve"
          else
            echo "‚ùå REJECTING BUILD $BUILD_ID due to high diff"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/unapprove"
            exit 1
          fi
