name: Cypress + Percy Visual Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # -------------------------------------------------------
  # CYPRESS + PERCY TEST EXECUTION
  # -------------------------------------------------------
  cypress-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i

      - name: Install Percy CLI
        run: npm install -g @percy/cli

      - name: Run Cypress Tests with Percy
        run: npm run test


  # -------------------------------------------------------
  # FINAL PERCY REVIEW JOB
  # -------------------------------------------------------
  percy-review:
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_API: "https://percy.io/api/v1"
      TARGET_PROJECT_NAME: "santosh-github-actions2"
      PERCY_USERNAME: ${{ secrets.PERCY_USERNAME }}
      PERCY_ACCESS_KEY: ${{ secrets.PERCY_ACCESS_KEY }}

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq



      # =====================================================
      # 1Ô∏è‚É£ FETCH PROJECT DETAILS
      # =====================================================
      - name: Fetch Percy Project Info
        id: fetch-project
        run: |
          echo "Fetching Percy Project..."

          PROJECT=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/projects")
          echo "$PROJECT" | jq

          PROJECT_NAME=$(echo "$PROJECT" | jq -r '.data.attributes.name')
          PROJECT_ID=$(echo "$PROJECT" | jq -r '.data.id')

          echo "PROJECT_NAME = $PROJECT_NAME"
          echo "PROJECT_ID   = $PROJECT_ID"

          if [[ "$PROJECT_NAME" != "$TARGET_PROJECT_NAME" ]]; then
            echo "‚ùå ERROR: Expected project '$TARGET_PROJECT_NAME' but actual is '$PROJECT_NAME'"
            exit 1
          fi

          echo "üéØ Project validated successfully"
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV



      # =====================================================
      # 2Ô∏è‚É£ FETCH THE LATEST BUILD
      # =====================================================
      - name: Fetch Latest Percy Build
        id: fetch-build
        run: |
          echo "Fetching builds for project ID: $PROJECT_ID"

          BUILDS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/projects/$PROJECT_ID/builds?per_page=10")

          echo "$BUILDS" | jq

          BUILD_ID=$(echo "$BUILDS" | jq -r '.data[0].id')

          if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
            echo "‚ùå No builds found for project $PROJECT_ID"
            exit 1
          fi

          echo "üéØ Latest Percy Build ID = $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV



      # =====================================================
      # ‚≠ê 2.5Ô∏è‚É£ WAIT FOR BUILD TO FINISH + SNAPSHOTS
      # =====================================================
      - name: Wait for Percy snapshots to arrive
        run: |
          echo "‚è≥ Waiting for Percy snapshots for build $BUILD_ID..."
          MAX_ATTEMPTS=60  # 10 minutes
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/builds/$BUILD_ID")

            STATE=$(echo "$DATA" | jq -r '.data.attributes.state')
            SNAPSHOTS=$(echo "$DATA" | jq -r '.data.attributes["total-snapshots"]')

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS ‚Üí state=$STATE, snapshots=$SNAPSHOTS"

            # Stop when finished
            if [[ "$STATE" == "finished" ]]; then
              echo "üéâ Build is finished!"
              break
            fi

            # Stop when snapshots exist
            if [[ "$SNAPSHOTS" != "null" && "$SNAPSHOTS" -gt 0 ]]; then
              echo "üì∏ Snapshots detected!"
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done

          if [[ "$STATE" != "finished" ]]; then
            echo "‚ùå Build did not finish in time"
            exit 1
          fi



      # =====================================================
      # 3Ô∏è‚É£ FETCH SNAPSHOT DETAILS + MAX DIFF-RATIO
      # =====================================================
      - name: Fetch Snapshot Details (Diff Ratios)
        id: snapshot-details
        run: |
          echo "=============================="
          echo "üì∏ Fetching Snapshot Details"
          echo "=============================="

          SNAPSHOTS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/builds/$BUILD_ID/snapshots?per_page=200")

          echo "$SNAPSHOTS" | jq -C

          SNAPSHOT_COUNT=$(echo "$SNAPSHOTS" | jq '.data | length // 0')
          echo "Total Snapshots Found: $SNAPSHOT_COUNT"

          if [[ "$SNAPSHOT_COUNT" -eq 0 ]]; then
            echo "‚ùå No snapshots found"
            echo "MAX_DIFF=0" >> $GITHUB_ENV
            echo "SNAPSHOT_COUNT=0" >> $GITHUB_ENV
            exit 0
          fi

          MAX_DIFF=0

          echo ""
          echo "Snapshot Diff Summary:"
          echo "------------------------------------------------"

          while IFS= read -r row; do
            NAME=$(echo "$row" | jq -r '.attributes.name')
            DIFF=$(echo "$row" | jq -r '.attributes["diff-ratio"]')

            if [[ "$DIFF" == "null" || -z "$DIFF" ]]; then
              DIFF=0
            fi

            printf "Snapshot: %-40s | Diff Ratio: %s\n" "$NAME" "$DIFF"

            # Update max
            if (( $(echo "$DIFF > $MAX_DIFF" | bc -l) )); then
              MAX_DIFF=$DIFF
            fi
          done < <(echo "$SNAPSHOTS" | jq -c '.data[]')

          echo "------------------------------------------------"
          echo "üìä MAX DIFF RATIO = $MAX_DIFF"
          echo "------------------------------------------------"

          echo "MAX_DIFF=$MAX_DIFF" >> $GITHUB_ENV
          echo "SNAPSHOT_COUNT=$SNAPSHOT_COUNT" >> $GITHUB_ENV



      # =====================================================
      # 4Ô∏è‚É£ APPROVE OR UNAPPROVE SAFELY (with refreshed state)
      # =====================================================
      - name: Approve or Reject Build
        run: |
          echo "=============================="
          echo "üö¶ Final Approval Decision"
          echo "=============================="

          THRESHOLD=0.05  # 5%

          echo "Build ID:      $BUILD_ID"
          echo "Snapshots:     $SNAPSHOT_COUNT"
          echo "Max Diff:      $MAX_DIFF"
          echo "Threshold:     $THRESHOLD"

          AUTH=$(echo -n "$PERCY_USERNAME:$PERCY_ACCESS_KEY" | base64)

          refresh_state() {
            CURRENT_STATE=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID" | jq -r '.data.attributes."review-state"')
          }

          refresh_state
          echo "Initial review state = $CURRENT_STATE"

          approve_build() {
            refresh_state
            if [[ "$CURRENT_STATE" == "approved" ]]; then
              echo "‚úî Build already APPROVED ‚Äî skipping"
              return
            fi

            echo "‚úî Sending APPROVE request..."
            curl -s -X POST \
              -H "Authorization: Basic $AUTH" \
              -H "Content-Type: application/json" \
              -d "{
                    \"data\": {
                      \"attributes\": { \"action\": \"approve\" },
                      \"relationships\": {
                        \"build\": { \"data\": { \"type\": \"builds\", \"id\": \"$BUILD_ID\" } }
                      },
                      \"type\": \"reviews\"
                    }
                  }" \
              https://percy.io/api/v1/reviews

            refresh_state
            echo "New review state = $CURRENT_STATE"
          }

          unapprove_build() {
            refresh_state
            if [[ "$CURRENT_STATE" == "unapproved" ]]; then
              echo "‚úî Build already UNAPPROVED ‚Äî skipping"
              return
            fi

            echo "‚ùå Sending UNAPPROVE request..."
            curl -s -X POST \
              -H "Authorization: Basic $AUTH" \
              -H "Content-Type: application/json" \
              -d "{
                    \"data\": {
                      \"attributes\": { \"action\": \"unapprove\" },
                      \"relationships\": {
                        \"build\": { \"data\": { \"type\": \"builds\", \"id\": \"$BUILD_ID\" } }
                      },
                      \"type\": \"reviews\"
                    }
                  }" \
              https://percy.io/api/v1/reviews

            refresh_state
            echo "New review state = $CURRENT_STATE"
          }

          # -----------------------------
          # DECISION LOGIC
          # -----------------------------
          if (( $(echo "$MAX_DIFF <= $THRESHOLD" | bc -l) )); then
            echo "üéâ APPROVING build (diff is within limit)"
            approve_build
          else
            echo "üö´ UNAPPROVING build (diff too high)"
            unapprove_build
            exit 1
          fi
