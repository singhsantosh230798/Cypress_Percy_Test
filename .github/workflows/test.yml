name: Cypress + Percy Visual Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i

      - name: Install Percy CLI
        run: npm install -g @percy/cli

      - name: Run Cypress tests with Percy
        run: npx percy exec -- npm run test


  # -------------------------------------------------------------------
  # Percy Review Job (runs AFTER all parallel jobs)
  # -------------------------------------------------------------------
  percy-review:
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_API: "https://percy.io/api/v1"

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      # ----------------------------------------------------
      # PRINT PROJECT INFO (NEW ADDITION)
      # ----------------------------------------------------
      - name: Print Percy Project Info
        run: |
          echo "Fetching Percy Project Information..."
          PROJECT_DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/projects")
          echo "$PROJECT_DATA" | jq

          PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.data[0].id')
          PROJECT_NAME=$(echo "$PROJECT_DATA" | jq -r '.data[0].attributes.name')

          echo "Percy Project ID: $PROJECT_ID"
          echo "Percy Project Name: $PROJECT_NAME"
          echo "PERCY_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV


      # ----------------------------------------------------
      # 1️⃣ FIND PERCY BUILD SAFELY (YOUR FIXED CODE)
      # ----------------------------------------------------
      - name: Find Percy build
        id: find-build
        run: |
          echo "Searching Percy build..."
          echo "Branch = $GITHUB_REF_NAME"
          echo "Commit = $GITHUB_SHA"

          BUILD_ID=""

          for i in {1..30}; do
            echo "Attempt $i/30..."

            RESPONSE=$(curl -sf -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds?filter[sha]=$GITHUB_SHA&per_page=20" || echo "")

            BUILD_ID=$(echo "$RESPONSE" | jq -er '.data[0].id' 2>/dev/null || echo "")

            if [[ -z "$BUILD_ID" ]]; then
              RESPONSE=$(curl -sf -H "Authorization: Token $PERCY_TOKEN" \
                "$PERCY_API/builds?filter[branch]=$GITHUB_REF_NAME&per_page=20" || echo "")

              BUILD_ID=$(echo "$RESPONSE" | jq -er '.data[0].id' 2>/dev/null || echo "")
            fi

            if [[ -n "$BUILD_ID" ]]; then
              echo "Percy build found: $BUILD_ID"
              echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
              echo "FOUND=true" >> $GITHUB_ENV
              break
            fi

            sleep 5
          done

          if [[ -z "$BUILD_ID" ]]; then
            echo "❌ No Percy build found for commit or branch."
            echo "FOUND=false" >> $GITHUB_ENV
          fi


      # ----------------------------------------------------
      # 2️⃣ PRINT BUILD DETAILS (NEW ADDITION)
      # ----------------------------------------------------
      - name: Print Percy Build Info
        if: env.FOUND == 'true'
        run: |
          echo "Fetching Percy Build Details..."
          BUILD_DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/builds/$BUILD_ID")

          echo "$BUILD_DATA" | jq

          BUILD_URL=$(echo "$BUILD_DATA" | jq -r '.data.attributes."web-url"')
          BUILD_STATE=$(echo "$BUILD_DATA" | jq -r '.data.attributes.state')
          REVIEW_STATE=$(echo "$BUILD_DATA" | jq -r '.data.attributes."review-state"')
          SNAPSHOTS=$(echo "$BUILD_DATA" | jq -r '.data.attributes."total-snapshots"')
          DIFFS=$(echo "$BUILD_DATA" | jq -r '.data.attributes."total-diffs"')
          COMMIT_SHA=$(echo "$BUILD_DATA" | jq -r '.data.attributes."commit-sha"')
          BRANCH=$(echo "$BUILD_DATA" | jq -r '.data.attributes.branch')

          echo "Percy Build ID: $BUILD_ID"
          echo "Percy Build URL: $BUILD_URL"
          echo "Build State: $BUILD_STATE"
          echo "Review State: $REVIEW_STATE"
          echo "Snapshots: $SNAPSHOTS"
          echo "Diffs: $DIFFS"
          echo "Commit SHA: $COMMIT_SHA"
          echo "Branch: $BRANCH"


      # ----------------------------------------------------
      # 3️⃣ Compute DIFF %
      # ----------------------------------------------------
      - name: Compute diff percentage
        if: env.FOUND == 'true'
        run: |
          DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/builds/$BUILD_ID")

          TOTAL=$(echo "$DATA" | jq '.data.attributes["total-snapshots"]')
          DIFFS=$(echo "$DATA" | jq '.data.attributes["total-diffs"]')

          if [[ "$TOTAL" -gt 0 ]]; then
            PERCENT=$(echo "scale=2; $DIFFS * 100 / $TOTAL" | bc)
          else
            PERCENT=0
          fi

          echo "Diff %: $PERCENT"
          echo "DIFF_PERCENT=$PERCENT" >> $GITHUB_ENV


      # ----------------------------------------------------
      # 4️⃣ APPROVE OR UNAPPROVE BUILD
      # ----------------------------------------------------
      - name: Approve or reject Percy build
        if: env.FOUND == 'true'
        run: |
          THRESHOLD=1

          echo "Threshold = $THRESHOLD%"
          echo "Actual Diff = $DIFF_PERCENT%"

          if (( $(echo "$DIFF_PERCENT <= $THRESHOLD" | bc -l) )); then
            echo "Approving build: $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/approve"
          else
            echo "Rejecting build: $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/unapprove"
            exit 1
          fi
