name: Cypress + Percy Visual Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]   # parallel containers

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i

      - name: Install Percy CLI
        run: npm install -g @percy/cli

      - name: Run Cypress tests with Percy
        run: npx percy exec -- npm run test


  # -------------------------------------------------------------------
  # Percy Review Job (runs after all parallel test containers complete)
  # -------------------------------------------------------------------
  percy-review:
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_API: "https://percy.io/api/v1"

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      # ---------------------------------------------------------------
      # 1️⃣ FIND PERCY BUILD (via official filter[sha] and filter[branch])
      # ---------------------------------------------------------------
      - name: Find Percy build
        id: find-build
        run: |
          echo "Searching Percy build..."
          echo "Branch = $GITHUB_REF_NAME"
          echo "Commit = $GITHUB_SHA"

          BUILD_ID=""

          for i in {1..30}; do
            echo "Attempt $i/30..."

            # First, attempt via commit SHA
            RESPONSE=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds?filter[sha]=$GITHUB_SHA&per_page=20")

            BUILD_ID=$(echo "$RESPONSE" | jq -r '.data[0].id')

            # If commit not found, attempt via branch
            if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
              RESPONSE=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
                "$PERCY_API/builds?filter[branch]=$GITHUB_REF_NAME&per_page=20")

              BUILD_ID=$(echo "$RESPONSE" | jq -r '.data[0].id')
            fi

            if [[ ! -z "$BUILD_ID" && "$BUILD_ID" != "null" ]]; then
              echo "Percy build found: $BUILD_ID"
              echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
              echo "FOUND=true" >> $GITHUB_ENV
              break
            fi

            sleep 5
          done

          if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
            echo "❌ No Percy build found for commit or branch."
            echo "FOUND=false" >> $GITHUB_ENV
          fi


      # ---------------------------------------------------------------
      # 2️⃣ FETCH BUILD DETAILS (snapshots, diffs, % difference)
      # ---------------------------------------------------------------
      - name: Compute diff percentage
        if: env.FOUND == 'true'
        run: |
          echo "Fetching Percy build details for ID: $BUILD_ID"

          DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/builds/$BUILD_ID")

          TOTAL=$(echo "$DATA" | jq '.data.attributes["total-snapshots"]')
          DIFFS=$(echo "$DATA" | jq '.data.attributes["total-diffs"]')

          if [[ "$TOTAL" -gt 0 ]]; then
            PERCENT=$(echo "scale=2; $DIFFS * 100 / $TOTAL" | bc)
          else
            PERCENT=0
          fi

          echo "Total snapshots: $TOTAL"
          echo "Diff snapshots: $DIFFS"
          echo "Diff percentage: $PERCENT%"

          echo "DIFF_PERCENT=$PERCENT" >> $GITHUB_ENV


      # ---------------------------------------------------------------
      # 3️⃣ APPROVE OR UNAPPROVE USING OFFICIAL ENDPOINTS
      # ---------------------------------------------------------------
      - name: Approve or reject Percy build
        if: env.FOUND == 'true'
        run: |
          THRESHOLD=1
          echo "Threshold: ${THRESHOLD}%"
          echo "Actual diff: ${DIFF_PERCENT}%"

          if (( $(echo "$DIFF_PERCENT <= $THRESHOLD" | bc -l) )); then
            echo "✔ Approving build ID: $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/approve"
          else
            echo "❌ Difference too high → Unapproving build ID: $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/unapprove"

            exit 1
          fi
