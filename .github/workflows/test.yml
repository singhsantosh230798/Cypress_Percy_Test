name: Cypress + Percy Visual Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i

      - name: Install Percy CLI
        run: npm install -g @percy/cli

      - name: Run Cypress Tests with Percy
        run: npx percy exec -- npm run test


  # -------------------------------------------------------
  # FINAL WORKING PERCY REVIEW JOB
  # -------------------------------------------------------
  percy-review:
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_API: "https://percy.io/api/v1"
      TARGET_PROJECT_NAME: "Santosh_cypress"

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      # -------------------------------------------------------
      # 1Ô∏è‚É£ GET PROJECTS ‚Üí VALIDATE PROJECT NAME & ID
      # -------------------------------------------------------
      - name: Fetch Percy Project Info
        run: |
          echo "Fetching Percy Projects..."

          PROJECTS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/projects")
          echo "$PROJECTS" | jq

          PROJECT_ID=$(echo "$PROJECTS" | jq -r --arg name "$TARGET_PROJECT_NAME" '.data[] | select(.attributes.name == $name) | .id')

          if [[ -z "$PROJECT_ID" ]]; then
            echo "‚ùå ERROR: Percy project '$TARGET_PROJECT_NAME' not found!"
            exit 1
          fi

          echo "üéØ FOUND PROJECT ‚Üí Name: $TARGET_PROJECT_NAME | ID: $PROJECT_ID"
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV


      # -------------------------------------------------------
      # 2Ô∏è‚É£ GET RECENT BUILDS FOR THAT PROJECT
      #     (Using official doc)
      #     https://www.browserstack.com/docs/percy/api-reference/builds#list-recent-builds
      # -------------------------------------------------------
      - name: Fetch Recent Builds for Project
        run: |
          echo "Fetching builds for project $PROJECT_ID"

          BUILDS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/builds?filter[project_id]=$PROJECT_ID&per_page=10")

          echo "$BUILDS" | jq

          BUILD_ID=$(echo "$BUILDS" | jq -r '.data[0].id')

          if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
            echo "‚ùå No recent builds found for project: $TARGET_PROJECT_NAME"
            exit 1
          fi

          echo "üéØ LATEST BUILD ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV


      # -------------------------------------------------------
      # 3Ô∏è‚É£ GET BUILD DETAILS (Official doc)
      #     https://www.browserstack.com/docs/percy/api-reference/builds#get-build-details
      # -------------------------------------------------------
      - name: Fetch Build Details
        run: |
          echo "Fetching build details for build $BUILD_ID"

          DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/builds/$BUILD_ID")
          echo "$DATA" | jq

          TOTAL=$(echo "$DATA" | jq '.data.attributes["total-snapshots"]')
          DIFFS=$(echo "$DATA" | jq '.data.attributes["total-diffs"]')
          BUILD_URL=$(echo "$DATA" | jq -r '.data.attributes."web-url"')

          if [[ "$TOTAL" -gt 0 ]]; then
            PERCENT=$(echo "scale=2; $DIFFS * 100 / $TOTAL" | bc)
          else
            PERCENT=0
          fi

          echo "Snapshots = $TOTAL"
          echo "Diffs = $DIFFS"
          echo "Diff % = $PERCENT"

          echo "DIFF_PERCENT=$PERCENT" >> $GITHUB_ENV


      # -------------------------------------------------------
      # 4Ô∏è‚É£ APPROVE OR DENY BUILD (Official API)
      #     https://www.browserstack.com/docs/percy/api-reference/builds#approve-build
      #     https://www.browserstack.com/docs/percy/api-reference/builds#unapprove-build
      # -------------------------------------------------------
      - name: Approve or Reject Build
        run: |
          THRESHOLD=1

          echo "Threshold = $THRESHOLD%"
          echo "Visual Diff = $DIFF_PERCENT%"

          if (( $(echo "$DIFF_PERCENT <= $THRESHOLD" | bc -l) )); then
            echo "‚úî APPROVING BUILD $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/approve"
          else
            echo "‚ùå REJECTING BUILD $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/unapprove"
            exit 1
          fi
