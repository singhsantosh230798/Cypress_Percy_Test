name: Cypress + Percy Visual Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # -------------------------------------------------------
  # TEST JOB: Runs Cypress + Percy in parallel
  # -------------------------------------------------------
  cypress-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm i

      - name: Install Percy CLI
        run: npm install -g @percy/cli

      - name: Run Cypress Tests with Percy
        run: npx percy exec -- npm run test


  # -------------------------------------------------------
  # REVIEW JOB: Fetch Percy project ‚Üí build ‚Üí approve/deny
  # -------------------------------------------------------
  percy-review:
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()

    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_API: "https://percy.io/api/v1"
      TARGET_PROJECT_NAME: "Santosh_cypress"

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      # -------------------------------------------------------
      # 1Ô∏è‚É£ FETCH ALL PERCY PROJECTS ‚Üí FIND MATCHING PROJECT
      # -------------------------------------------------------
      - name: Fetch Percy Project ID
        id: percy-project
        run: |
          echo "Fetching all Percy projects..."
          PROJECTS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/projects")

          echo "All Percy projects:"
          echo "$PROJECTS" | jq

          PROJECT_ID=$(echo "$PROJECTS" | jq -r --arg name "$TARGET_PROJECT_NAME" '.data[] | select(.attributes.name == $name) | .id')

          if [[ -z "$PROJECT_ID" ]]; then
            echo "‚ùå ERROR: Percy project '$TARGET_PROJECT_NAME' not found!"
            exit 1
          fi

          echo "üéØ Percy Project Found: $TARGET_PROJECT_NAME ‚Üí ID: $PROJECT_ID"
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV


      # -------------------------------------------------------
      # 2Ô∏è‚É£ FETCH LATEST BUILD FROM THAT PROJECT
      # -------------------------------------------------------
      - name: Fetch Latest Percy Build
        id: percy-build
        run: |
          echo "Fetching builds for project ID: $PROJECT_ID"

          BUILDS=$(curl -s -H "Authorization: Token $PERCY_TOKEN" \
            "$PERCY_API/builds?filter[project_id]=$PROJECT_ID&per_page=10")

          echo "Latest Builds:"
          echo "$BUILDS" | jq

          BUILD_ID=$(echo "$BUILDS" | jq -r '.data[0].id')

          if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
            echo "‚ùå No builds found for project: $TARGET_PROJECT_NAME"
            exit 1
          fi

          echo "üéØ Latest Percy Build ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV


      # -------------------------------------------------------
      # 3Ô∏è‚É£ FETCH BUILD DETAILS (SNAPSHOTS, DIFFS, STATE)
      # -------------------------------------------------------
      - name: Fetch Build Details
        id: build-info
        run: |
          echo "Fetching details for build: $BUILD_ID"

          DATA=$(curl -s -H "Authorization: Token $PERCY_TOKEN" "$PERCY_API/builds/$BUILD_ID")

          echo "$DATA" | jq

          TOTAL=$(echo "$DATA" | jq '.data.attributes["total-snapshots"]')
          DIFFS=$(echo "$DATA" | jq '.data.attributes["total-diffs"]')
          BUILD_URL=$(echo "$DATA" | jq -r '.data.attributes."web-url"')
          COMMIT_SHA=$(echo "$DATA" | jq -r '.data.attributes."commit-sha"')
          BRANCH=$(echo "$DATA" | jq -r '.data.attributes.branch')

          if [[ "$TOTAL" -gt 0 ]]; then
            PERCENT=$(echo "scale=2; $DIFFS * 100 / $TOTAL" | bc)
          else
            PERCENT=0
          fi

          echo "----------------------------------------"
          echo "Percy Build Summary"
          echo "----------------------------------------"
          echo "Build ID:       $BUILD_ID"
          echo "Build URL:      $BUILD_URL"
          echo "Project ID:     $PROJECT_ID"
          echo "Branch:         $BRANCH"
          echo "Commit SHA:     $COMMIT_SHA"
          echo "Snapshots:      $TOTAL"
          echo "Diff snapshots: $DIFFS"
          echo "Diff %:         $PERCENT"
          echo "----------------------------------------"

          echo "DIFF_PERCENT=$PERCENT" >> $GITHUB_ENV


      # -------------------------------------------------------
      # 4Ô∏è‚É£ APPROVE OR UNAPPROVE BASED ON DIFF %
      # -------------------------------------------------------
      - name: Approve or Reject Percy Build
        run: |
          THRESHOLD=1

          echo "Threshold: $THRESHOLD%"
          echo "Actual diff: $DIFF_PERCENT%"

          if (( $(echo "$DIFF_PERCENT <= $THRESHOLD" | bc -l) )); then
            echo "‚úî APPROVING Percy build $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/approve"
          else
            echo "‚ùå REJECTING Percy build $BUILD_ID"
            curl -s -X POST \
              -H "Authorization: Token $PERCY_TOKEN" \
              "$PERCY_API/builds/$BUILD_ID/unapprove"
            exit 1
          fi
